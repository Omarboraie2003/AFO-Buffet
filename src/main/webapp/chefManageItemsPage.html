<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buffet Menu</title>
    <style>
        /* Your existing CSS remains unchanged */
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:linear-gradient(135deg,#1a1a1a 0%,#2d2d2d 50%,#1a1a1a 100%);min-height:100vh}
        .container{max-width:1400px;margin:0 auto;padding:20px}
        .header{margin-bottom:30px}
        .nav-frame{background:rgba(255,255,255,0.95);backdrop-filter:blur(20px);border-radius:15px;padding:15px 20px;box-shadow:0 8px 32px rgba(255,131,0,0.3);border:1px solid rgba(255,131,0,0.2);display:flex;align-items:center;justify-content:space-between;width:100%}
        .home-icon{width:35px;height:35px;background:linear-gradient(135deg,#ff8300,#ffaa00);border-radius:8px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(255,131,0,0.3);overflow:hidden;cursor:pointer;transition:all 0.2s ease;text-decoration:none;border:1px solid rgba(255,131,0,0.3)}
        .home-icon:hover{transform:scale(1.05);box-shadow:0 6px 16px rgba(255,131,0,0.4);background:linear-gradient(135deg,#ffaa00,#ff8300)}
        .home-icon img{width:100%;height:100%;object-fit:cover}
        .nav-buttons{display:flex;gap:15px}
        .nav-btn{padding:12px 40px;border:2px solid #ccc;border-radius:25px;background-color:white;font-size:16px;cursor:pointer;transition:all 0.3s ease;text-decoration:none;display:inline-block}
        .nav-btn.active{border-color:#ff8300;color:white;background:linear-gradient(135deg,#ff8300,#ffaa00);box-shadow:0 4px 12px rgba(255,131,0,0.3)}
        .nav-btn:hover{border-color:#ff8300;transform:translateY(-2px);box-shadow:0 6px 16px rgba(0,0,0,0.15);color:#ff8300}
        .main-content{display:grid;grid-template-columns:1fr 280px;gap:30px;margin-bottom:30px;max-width:1200px;margin-left:auto;margin-right:auto}
        .featured-section{background:linear-gradient(135deg,#1a1a1a 0%,#333333 100%);border-radius:20px;padding:30px;display:flex;align-items:center;justify-content:space-between;min-height:180px;max-height:220px;color:white;position:relative;overflow:hidden;border:1px solid rgba(255,131,0,0.2)}
        .featured-section::before{content:'';position:absolute;top:-50%;right:-50%;width:200%;height:200%;background:radial-gradient(circle,rgba(255,131,0,0.1) 0%,transparent 70%);animation:float 6s ease-in-out infinite}
        @keyframes float{0%,100%{transform:translateY(0px) rotate(0deg)}50%{transform:translateY(-10px) rotate(180deg)}}
        .featured-text{flex:1;position:relative;z-index:2}
        .featured-text h2{font-size:24px;color:rgba(255,255,255,0.9);margin-bottom:10px;font-weight:400}
        .featured-text h1{font-size:36px;color:#ff8300;font-weight:700;font-style:italic;text-shadow:0 2px 4px rgba(0,0,0,0.3)}
        .featured-image{flex:1;display:flex;justify-content:center;align-items:center;max-width:250px;min-height:120px;background:rgba(255,255,255,0.1);border-radius:12px;color:rgba(255,255,255,0.7);font-style:italic;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.2);position:relative;z-index:2}
        .featured-image::after{content:"Featured Image"}
        .featured-image img{width:100%;height:auto;border-radius:15px}
        .new-item-section{background:linear-gradient(135deg,#4a4a4a,#333);border-radius:20px;padding:25px;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;color:white;cursor:pointer;transition:all 0.3s ease;height:220px}
        .new-item-section:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(0,0,0,0.2)}
        .plus-icon{width:50px;height:50px;border-radius:50%;background-color:#333;display:flex;align-items:center;justify-content:center;font-size:24px;margin-bottom:15px}
        .new-item-section h3{font-size:18px;font-weight:500}
        .category-filters{display:flex;gap:15px;margin-bottom:30px;align-items:center;flex-wrap:wrap;justify-content:center;background:rgba(255,255,255,0.9);backdrop-filter:blur(20px);padding:20px;border-radius:15px;box-shadow:0 8px 32px rgba(0,0,0,0.1);border:1px solid rgba(255,255,255,0.2)}
        .category-btn{padding:10px 25px;border:2px solid #ccc;border-radius:20px;background-color:white;font-size:14px;cursor:pointer;transition:all 0.3s ease}
        .category-btn.active{border-color:#ff6b35;color:#ff6b35;background-color:rgba(255,107,53,0.05);transform:translateY(-1px)}
        .category-btn:hover{border-color:#ff6b35;transform:translateY(-1px);box-shadow:0 4px 8px rgba(0,0,0,0.1)}
        .availability-toggle{display:flex;align-items:center;gap:10px}
        .toggle-switch{width:50px;height:25px;background-color:#ff9500;border-radius:15px;position:relative;cursor:pointer;transition:all 0.3s ease}
        .toggle-switch.off{background-color:#ccc}
        .toggle-switch::after{content:'';width:21px;height:21px;background-color:white;border-radius:50%;position:absolute;top:2px;right:2px;transition:all 0.3s ease}
        .toggle-switch.off::after{right:calc(100% - 23px)}
        .products-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px}
        .product-card{background-color:white;border-radius:15px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,0.1);transition:all 0.3s ease;cursor:pointer;display:flex;flex-direction:column}
        .product-card:hover{transform:translateY(-8px);box-shadow:0 12px 24px rgba(0,0,0,0.15)}
        .product-image{width:100%;height:200px;background-color:#f0f0f0;display:flex;align-items:center;justify-content:center;color:#999}
        .product-details{padding:15px;flex:1;display:flex;flex-direction:column;align-items:center;text-align:center}
        .product-name{font-size:16px;font-weight:500;color:#333;margin-bottom:5px}
        .product-desc{font-size:14px;color:#555;margin-bottom:5px}
        .product-price{font-size:15px;font-weight:600;color:#ff8300;margin-bottom:5px}
        .product-availability{font-size:13px;color:green;font-weight:500}
        .product-availability.unavailable{color:red}

        /* Added beautiful toast notification styles */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            border-left: 4px solid;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 320px;
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(10px);
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.success {
            border-left-color: #4CAF50;
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(255, 255, 255, 0.95));
        }

        .toast.error {
            border-left-color: #f44336;
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.1), rgba(255, 255, 255, 0.95));
        }

        .toast-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            color: white;
            flex-shrink: 0;
        }

        .toast.success .toast-icon {
            background: #4CAF50;
        }

        .toast.error .toast-icon {
            background: #f44336;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 2px;
            color: #333;
        }

        .toast-message {
            font-size: 13px;
            color: #666;
            line-height: 1.4;
        }

        .toast-close {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.1);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #666;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .toast-close:hover {
            background: rgba(0, 0, 0, 0.2);
            transform: scale(1.1);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        /* Added styles for special toggle button */
        .special-toggle {
            margin-top: 10px;
            padding: 8px 16px;
            border: 2px solid #ff8300;
            border-radius: 20px;
            background: white;
            color: #ff8300;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .special-toggle:hover {
            background: #ff8300;
            color: white;
            transform: translateY(-1px);
        }

        .special-toggle.active {
            background: linear-gradient(135deg, #ff8300, #ffaa00);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 131, 0, 0.3);
        }

        .special-toggle.active:hover {
            background: linear-gradient(135deg, #ffaa00, #ff8300);
        }
    </style>
</head>
<body>
<div class="container">
    <!-- Header -->
    <header class="header">
        <div class="nav-frame">
            <a href="chefWelcomePage.html" class="home-icon"><img src="images/home.jpg" alt="Home"></a>
            <div class="nav-buttons">
                <a href="chefManageItemsPage.html" class="nav-btn active">Menu</a>
                <a href="orders.html" class="nav-btn">Orders</a>
            </div>
            <div></div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="main-content">
        <div class="featured-section">
            <div class="featured-text">
                <h2>Today's special</h2>
                <h1 id="todaysSpecialName">No special selected</h1>
            </div>
            <div class="featured-image"></div>
        </div>
        <div class="new-item-section">
            <div class="plus-icon" id="addNewItemBtn">+</div>
            <h3>New Item</h3>
        </div>
    </div>

    <!-- Category Filters -->
    <div class="category-filters">
        <!-- Added search bar before category buttons -->
        <div style="display: flex; align-items: center; gap: 15px; margin-right: 20px;">
            <input
                    type="text"
                    id="searchInput"
                    placeholder="Search menu items..."
                    style="padding: 10px 15px; border: 2px solid #ddd; border-radius: 20px; font-size: 14px; width: 250px; transition: all 0.3s ease;"
                    onkeyup="handleSearch()"
            >
            <button
                    id="clearSearchBtn"
                    onclick="clearSearch()"
                    style="padding: 8px 12px; border: 2px solid #ff8300; border-radius: 15px; background: white; color: #ff8300; font-size: 12px; cursor: pointer; transition: all 0.3s ease; display: none;"
            >
                Clear
            </button>
        </div>

        <button class="category-btn active" data-category="All">All</button>
        <!-- Added star filter button for special items -->
        <button class="category-btn" data-category="Special" style="background: linear-gradient(135deg, #ff8300, #ffaa00); color: white; border-color: #ff8300;">⭐ Special Items</button>
        <button class="category-btn">Salads</button>
        <button class="category-btn">Breakfast</button>
        <button class="category-btn">Sandwiches</button>
        <button class="category-btn">Meal</button>
        <button class="category-btn">Extras</button>
        <div class="availability-toggle">
            <span>Available</span>
            <div class="toggle-switch"></div>
        </div>
    </div>

    <!-- Products Grid -->
    <div class="products-grid"></div>
</div>

<!-- Added toast container for beautiful notifications -->
<div class="toast-container" id="toastContainer"></div>

<!-- Hidden form for adding new menu item -->
<div id="newItemFormContainer" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:30px; border-radius:15px; box-shadow:0 8px 32px rgba(0,0,0,0.3); z-index:1000; width:90%; max-width:500px;">
    <h3 style="margin-bottom:20px; color:#333; text-align:center;">Add New Menu Item</h3>
    <form id="newItemForm" style="display:flex; flex-direction:column; gap:15px;">
        <div>
            <label for="itemName" style="display:block; margin-bottom:5px; font-weight:500; color:#333;">Name:</label>
            <input type="text" id="itemName" name="name" required style="width:100%; padding:10px; border:2px solid #ddd; border-radius:8px; font-size:14px;">
        </div>

        <div>
            <label for="itemDescription" style="display:block; margin-bottom:5px; font-weight:500; color:#333;">Description:</label>
            <textarea id="itemDescription" name="description" required style="width:100%; padding:10px; border:2px solid #ddd; border-radius:8px; font-size:14px; min-height:80px; resize:vertical;"></textarea>
        </div>

        <div>
            <label for="itemPrice" style="display:block; margin-bottom:5px; font-weight:500; color:#333;">Price:</label>
            <input type="number" id="itemPrice" name="price" step="0.01" required style="width:100%; padding:10px; border:2px solid #ddd; border-radius:8px; font-size:14px;">
        </div>

        <div>
            <label for="itemCategory" style="display:block; margin-bottom:5px; font-weight:500; color:#333;">Category:</label>
            <select id="itemCategory" name="category" required style="width:100%; padding:10px; border:2px solid #ddd; border-radius:8px; font-size:14px;">
                <option value="">Select Category</option>
                <option value="Salads">Salads</option>
                <option value="Breakfast">Breakfast</option>
                <option value="Sandwiches">Sandwiches</option>
                <option value="Meal">Meal</option>
                <option value="Extras">Extras</option>
            </select>
        </div>

        <div>
            <label for="itemAvailable" style="display:block; margin-bottom:5px; font-weight:500; color:#333;">Available:</label>
            <select id="itemAvailable" name="available" style="width:100%; padding:10px; border:2px solid #ddd; border-radius:8px; font-size:14px;">
                <option value="true">Yes</option>
                <option value="false">No</option>
            </select>
        </div>

        <div>
            <label for="itemType" style="display:block; margin-bottom:5px; font-weight:500; color:#333;">Type:</label>
            <select id="itemType" name="type" required style="width:100%; padding:10px; border:2px solid #ddd; border-radius:8px; font-size:14px;">
                <option value="normal">Normal</option>
                <option value="special">Special Item</option>
            </select>
        </div>

        <div style="display:flex; gap:10px; margin-top:20px;">
            <button type="submit" style="flex:1; padding:12px; background:linear-gradient(135deg,#ff8300,#ffaa00); color:white; border:none; border-radius:8px; font-size:16px; font-weight:500; cursor:pointer; transition:all 0.3s ease;">Add Item</button>
            <button type="button" id="cancelNewItem" style="flex:1; padding:12px; background:#f5f5f5; color:#333; border:2px solid #ddd; border-radius:8px; font-size:16px; font-weight:500; cursor:pointer; transition:all 0.3s ease;">Cancel</button>
        </div>
    </form>
</div>

<!-- Added edit form modal for editing existing items -->
<div id="editItemFormContainer" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:30px; border-radius:15px; box-shadow:0 8px 32px rgba(0,0,0,0.3); z-index:1000; width:90%; max-width:500px;">
    <h3 style="margin-bottom:20px; color:#333; text-align:center;">Edit Menu Item</h3>
    <form id="editItemForm" style="display:flex; flex-direction:column; gap:15px;">
        <input type="hidden" id="editItemId" name="id">

        <div>
            <label for="editItemName" style="display:block; margin-bottom:5px; font-weight:500; color:#333;">Name:</label>
            <input type="text" id="editItemName" name="name" required style="width:100%; padding:10px; border:2px solid #ddd; border-radius:8px; font-size:14px;">
        </div>

        <div>
            <label for="editItemDescription" style="display:block; margin-bottom:5px; font-weight:500; color:#333;">Description:</label>
            <textarea id="editItemDescription" name="description" required style="width:100%; padding:10px; border:2px solid #ddd; border-radius:8px; font-size:14px; min-height:80px; resize:vertical;"></textarea>
        </div>

        <div>
            <label for="editItemPrice" style="display:block; margin-bottom:5px; font-weight:500; color:#333;">Price:</label>
            <input type="number" id="editItemPrice" name="price" step="0.01" required style="width:100%; padding:10px; border:2px solid #ddd; border-radius:8px; font-size:14px;">
        </div>

        <div>
            <label for="editItemCategory" style="display:block; margin-bottom:5px; font-weight:500; color:#333;">Category:</label>
            <select id="editItemCategory" name="category" required style="width:100%; padding:10px; border:2px solid #ddd; border-radius:8px; font-size:14px;">
                <option value="">Select Category</option>
                <option value="Salads">Salads</option>
                <option value="Breakfast">Breakfast</option>
                <option value="Sandwiches">Sandwiches</option>
                <option value="Meal">Meal</option>
                <option value="Extras">Extras</option>
            </select>
        </div>

        <div>
            <label for="editItemAvailable" style="display:block; margin-bottom:5px; font-weight:500; color:#333;">Available:</label>
            <select id="editItemAvailable" name="available" style="width:100%; padding:10px; border:2px solid #ddd; border-radius:8px; font-size:14px;">
                <option value="true">Yes</option>
                <option value="false">No</option>
            </select>
        </div>

        <div>
            <label for="editItemType" style="display:block; margin-bottom:5px; font-weight:500; color:#333;">Type:</label>
            <select id="editItemType" name="type" required style="width:100%; padding:10px; border:2px solid #ddd; border-radius:8px; font-size:14px;">
                <option value="normal">Normal</option>
                <option value="special">Special Item</option>
            </select>
        </div>

        <div style="display:flex; gap:10px; margin-top:20px;">
            <button type="submit" style="flex:1; padding:12px; background:linear-gradient(135deg,#4CAF50,#45a049); color:white; border:none; border-radius:8px; font-size:16px; font-weight:500; cursor:pointer; transition:all 0.3s ease;">Update Item</button>
            <button type="button" id="setSpecialBtn" style="display:none; flex:1; padding:12px; background:linear-gradient(135deg,#ff8300,#ffaa00); color:white; border:none; border-radius:8px; font-size:16px; font-weight:500; cursor:pointer; transition:all 0.3s ease;">Set as Today's Special</button>
            <button type="button" id="deleteItemBtn" style="flex:1; padding:12px; background:linear-gradient(135deg,#f44336,#d32f2f); color:white; border:none; border-radius:8px; font-size:16px; font-weight:500; cursor:pointer; transition:all 0.3s ease;">Delete Item</button>
            <button type="button" id="cancelEditItem" style="flex:1; padding:12px; background:#f5f5f5; color:#333; border:2px solid #ddd; border-radius:8px; font-size:16px; font-weight:500; cursor:pointer; transition:all 0.3s ease;">Cancel</button>
        </div>
    </form>
</div>

<!-- Added confirmation dialog for delete action -->
<div id="deleteConfirmDialog" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:30px; border-radius:15px; box-shadow:0 8px 32px rgba(0,0,0,0.3); z-index:1001; width:90%; max-width:400px; text-align:center;">
    <div style="width:60px; height:60px; background:linear-gradient(135deg,#f44336,#d32f2f); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px; color:white; font-size:24px; font-weight:bold;">!</div>
    <h3 style="margin-bottom:15px; color:#333; font-size:20px;">Confirm Deletion</h3>
    <p style="margin-bottom:25px; color:#666; line-height:1.5;">Are you sure you want to delete "<span id="deleteItemName" style="font-weight:600; color:#333;"></span>"?</p>
    <p style="margin-bottom:25px; color:#f44336; font-size:14px; font-style:italic;">This action cannot be undone.</p>
    <div style="display:flex; gap:15px; justify-content:center;">
        <button id="confirmDeleteBtn" style="padding:12px 24px; background:linear-gradient(135deg,#f44336,#d32f2f); color:white; border:none; border-radius:8px; font-size:16px; font-weight:500; cursor:pointer; transition:all 0.3s ease;">Yes, Delete</button>
        <button id="cancelDeleteBtn" style="padding:12px 24px; background:#f5f5f5; color:#333; border:2px solid #ddd; border-radius:8px; font-size:16px; font-weight:500; cursor:pointer; transition:all 0.3s ease;">Cancel</button>
    </div>
</div>

<!-- Added overlay background for modal -->
<div id="modalOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999;"></div>

<script>
    const contextPath = '/AllForOneBuffetAPP'; // Your app context

    function loadTodaysSpecial() {
        fetch(contextPath + '/menu-items?todaysSpecial=true')
            .then(res => res.json())
            .then(data => {
                const specialNameElement = document.getElementById('todaysSpecialName');
                if (data && data.length > 0) {
                    specialNameElement.textContent = data[0].name;
                } else {
                    specialNameElement.textContent = 'No special selected';
                }
            })
            .catch(err => {
                console.error('[v0] Error loading today\'s special:', err);
                document.getElementById('todaysSpecialName').textContent = 'No special selected';
            });
    }

    function handleSearch() {
        const searchTerm = document.getElementById('searchInput').value.trim();
        const clearBtn = document.getElementById('clearSearchBtn');

        // Show/hide clear button based on search input
        if (searchTerm.length > 0) {
            clearBtn.style.display = 'block';
        } else {
            clearBtn.style.display = 'none';
        }

        const activeCategoryBtn = document.querySelector('.category-btn.active');
        let activeCategory = activeCategoryBtn ? activeCategoryBtn.textContent.trim() : null;
        if (activeCategory === 'All') activeCategory = null;
        const available = getAvailabilityState();

        loadMenu(activeCategory, available, searchTerm);
    }

    function clearSearch() {
        document.getElementById('searchInput').value = '';
        document.getElementById('clearSearchBtn').style.display = 'none';

        const activeCategoryBtn = document.querySelector('.category-btn.active');
        let activeCategory = activeCategoryBtn ? activeCategoryBtn.textContent.trim() : null;
        if (activeCategory === 'All') activeCategory = null;
        const available = getAvailabilityState();
        loadMenu(activeCategory, available);
    }

    function loadMenu(category = null, available = null, searchTerm = '') {
        let url = contextPath + '/menu-items';
        const params = [];

        if (category === 'Special') {
            params.push('type=special');
        } else if (category && category !== 'All') {
            params.push('category=' + encodeURIComponent(category));
        }

        if (available !== null) {
            params.push('available=' + (available ? 'true' : 'false'));
        }

        if (params.length > 0) {
            url += '?' + params.join('&');
        }

        let currentSpecialId = null;
        fetch(contextPath + '/menu-items?todaysSpecial=true')
            .then(res => res.json())
            .then(specialData => {
                if (specialData && specialData.length > 0) {
                    currentSpecialId = specialData[0].id;
                }
                return fetch(url);
            })
            .then(res => {
                console.log('[v0] Response status:', res.status);
                return res.json();
            })
            .then(data => {
                console.log('[v0] Received data:', data);
                console.log('[v0] Number of items received:', data.length);

                let filteredData = data;
                if (searchTerm && searchTerm.length > 0) {
                    const searchLower = searchTerm.toLowerCase();
                    filteredData = data.filter(item =>
                        item.name.toLowerCase().includes(searchLower) ||
                        item.description.toLowerCase().includes(searchLower) ||
                        item.category.toLowerCase().includes(searchLower)
                    );
                    console.log('[v0] Filtered to', filteredData.length, 'items for search:', searchTerm);
                }

                const grid = document.querySelector('.products-grid');
                grid.innerHTML = '';
                if (filteredData.length === 0) {
                    const noResultsMsg = searchTerm ?
                        `No items found matching "${searchTerm}"` :
                        'No items found';
                    grid.innerHTML = `<p style="color:white;text-align:center;grid-column:1/-1;padding:40px;font-size:18px;">${noResultsMsg}</p>`;
                    return;
                }
                filteredData.forEach(item => {
                    console.log('[v0] Processing item:', item.name, 'category:', item.category, 'available:', item.available);
                    const card = document.createElement('div');
                    card.className = 'product-card';
                    card.addEventListener('click', (e) => {
                        // Don't open edit form if clicking the special toggle button
                        if (!e.target.classList.contains('special-toggle')) {
                            openEditForm(item);
                        }
                    });

                    const imageDiv = document.createElement('div');
                    imageDiv.className = 'product-image';
                    if (item.imageUrl) {
                        const img = document.createElement('img');
                        img.src = item.imageUrl;
                        img.style.width = "100%";
                        img.style.height = "100%";
                        img.style.objectFit = "cover";
                        imageDiv.appendChild(img);
                    } else {
                        imageDiv.textContent = 'No Image';
                    }

                    const details = document.createElement('div');
                    details.className = 'product-details';

                    const name = document.createElement('div');
                    name.className = 'product-name';
                    name.textContent = item.name;

                    const desc = document.createElement('div');
                    desc.className = 'product-desc';
                    desc.textContent = item.description;

                    const price = document.createElement('div');
                    price.className = 'product-price';
                    price.textContent = '$' + item.price.toFixed(2);

                    const avail = document.createElement('div');
                    avail.className = 'product-availability';
                    avail.textContent = item.available ? 'Available' : 'Unavailable';
                    if (!item.available) avail.classList.add('unavailable');

                    if (item.type === 'special') {
                        const specialToggle = document.createElement('button');
                        specialToggle.className = 'special-toggle';
                        specialToggle.textContent = currentSpecialId === item.id ? '⭐ Today\'s Special' : 'Make Special';
                        if (currentSpecialId === item.id) {
                            specialToggle.classList.add('active');
                        }

                        specialToggle.addEventListener('click', (e) => {
                            e.stopPropagation(); // Prevent opening edit form
                            if (currentSpecialId === item.id) {
                                clearTodaysSpecial();
                            } else {
                                setTodaysSpecial(item.id, item.name);
                            }
                        });

                        details.appendChild(specialToggle);
                    }

                    details.appendChild(name);
                    details.appendChild(desc);
                    details.appendChild(price);
                    details.appendChild(avail);

                    card.appendChild(imageDiv);
                    card.appendChild(details);
                    grid.appendChild(card);
                });
            })
            .catch(err => {
                console.error('[v0] Error fetching menu items:', err);
                const grid = document.querySelector('.products-grid');
                grid.innerHTML = '<p style="color:white;text-align:center;grid-column:1/-1;padding:40px;font-size:18px;">Error loading items: ' + err.message + '</p>';
            });
    }

    document.querySelectorAll('.category-btn').forEach(button => {
        button.addEventListener('click', () => {
            console.log('[v0] Category button clicked:', button.textContent.trim());

            // Update active category button
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            // Get current filters
            let category = button.getAttribute('data-category') || button.textContent.trim();
            if (category === 'All') category = null;
            const available = getAvailabilityState();
            const searchTerm = document.getElementById('searchInput').value.trim(); // Preserve search

            console.log('[v0] Loading with category:', category, 'available:', available, 'search:', searchTerm);
            loadMenu(category, available, searchTerm);
        });
    });

    document.querySelector('.toggle-switch').addEventListener('click', function () {
        console.log('[v0] Toggle clicked, current classes:', this.className);

        if (!this.classList.contains('active') && !this.classList.contains('off')) {
            // Currently showing all, switch to available only
            this.classList.add('active');
            this.style.backgroundColor = '#4CAF50'; // Green for available
        } else if (this.classList.contains('active')) {
            // Currently showing available only, switch to unavailable only
            this.classList.remove('active');
            this.classList.add('off');
            this.style.backgroundColor = '#f44336'; // Red for unavailable
        } else {
            // Currently showing unavailable only, switch back to all
            this.classList.remove('off');
            this.style.backgroundColor = '#ff9500'; // Orange for all
        }

        // Get current filters and preserve them
        const activeCategoryBtn = document.querySelector('.category-btn.active');
        let activeCategory = activeCategoryBtn ? (activeCategoryBtn.getAttribute('data-category') || activeCategoryBtn.textContent.trim()) : null;
        if (activeCategory === 'All') activeCategory = null;
        const available = getAvailabilityState();
        const searchTerm = document.getElementById('searchInput').value.trim(); // Preserve search

        console.log('[v0] Toggle changed, loading with category:', activeCategory, 'available:', available, 'search:', searchTerm);
        loadMenu(activeCategory, available, searchTerm);
    });

    function getAvailabilityState() {
        const toggle = document.querySelector('.toggle-switch');
        if (toggle.classList.contains('active')) {
            return true; // Available only
        } else if (toggle.classList.contains('off')) {
            return false; // Unavailable only
        } else {
            return null; // Show all
        }
    }

    function openEditForm(item) {
        document.getElementById('editItemId').value = item.id;
        document.getElementById('editItemName').value = item.name;
        document.getElementById('editItemDescription').value = item.description;
        document.getElementById('editItemPrice').value = item.price;
        document.getElementById('editItemCategory').value = item.category;
        document.getElementById('editItemAvailable').value = item.available.toString();
        document.getElementById('editItemType').value = item.type;

        const editFormContainer = document.getElementById('editItemFormContainer');
        const modalOverlay = document.getElementById('modalOverlay');
        editFormContainer.style.display = 'block';
        modalOverlay.style.display = 'block';

        // Show/hide "Set as Today's Special" button based on item type
        const setSpecialBtn = document.getElementById('setSpecialBtn');
        if (item.type === 'special') {
            setSpecialBtn.style.display = 'block';
        } else {
            setSpecialBtn.style.display = 'none';
        }
    }

    function hideEditForm() {
        const editFormContainer = document.getElementById('editItemFormContainer');
        const modalOverlay = document.getElementById('modalOverlay');
        editFormContainer.style.display = 'none';
        modalOverlay.style.display = 'none';
    }

    function showDeleteConfirmation(itemName) {
        document.getElementById('deleteItemName').textContent = itemName;
        document.getElementById('deleteConfirmDialog').style.display = 'block';
        document.getElementById('modalOverlay').style.display = 'block';
    }

    function hideDeleteConfirmation() {
        document.getElementById('deleteConfirmDialog').style.display = 'none';
        document.getElementById('modalOverlay').style.display = 'none';
    }

    function setTodaysSpecial(itemId, itemName) {
        fetch(contextPath + '/menu-items/set-special?id=' + itemId, {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('success', 'Today\'s Special Set!', `"${itemName}" is now today\'s special.`);
                    loadTodaysSpecial(); // Refresh the banner
                    const activeCategoryBtn = document.querySelector('.category-btn.active');
                    let activeCategory = activeCategoryBtn ? (activeCategoryBtn.getAttribute('data-category') || activeCategoryBtn.textContent.trim()) : null;
                    if (activeCategory === 'All') activeCategory = null;
                    const available = getAvailabilityState();
                    const searchTerm = document.getElementById('searchInput').value.trim();
                    loadMenu(activeCategory, available, searchTerm);
                } else {
                    showToast('error', 'Failed to Set Special', data.message || 'An unexpected error occurred. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('error', 'Connection Error', 'Unable to connect to server. Please check your connection and try again.');
            });
    }

    function clearTodaysSpecial() {
        fetch(contextPath + '/menu-items/clear-special', {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('success', 'Special Cleared!', 'Today\'s special has been removed.');
                    loadTodaysSpecial(); // Refresh the banner
                    const activeCategoryBtn = document.querySelector('.category-btn.active');
                    let activeCategory = activeCategoryBtn ? (activeCategoryBtn.getAttribute('data-category') || activeCategoryBtn.textContent.trim()) : null;
                    if (activeCategory === 'All') activeCategory = null;
                    const available = getAvailabilityState();
                    const searchTerm = document.getElementById('searchInput').value.trim();
                    loadMenu(activeCategory, available, searchTerm);
                } else {
                    showToast('error', 'Failed to Clear Special', data.message || 'An unexpected error occurred. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('error', 'Connection Error', 'Unable to connect to server. Please check your connection and try again.');
            });
    }

    function showToast(type, title, message) {
        const container = document.getElementById('toastContainer');

        const toast = document.createElement('div');
        toast.className = `toast ${type}`;

        const icon = type === 'success' ? '✓' : '✕';

        toast.innerHTML = `
            <div class="toast-icon">${icon}</div>
            <div class="toast-content">
                <div class="toast-title">${title}</div>
                <div class="toast-message">${message}</div>
            </div>
            <button class="toast-close" onclick="this.parentElement.remove()">×</button>
        `;

        container.appendChild(toast);

        // Trigger animation
        setTimeout(() => toast.classList.add('show'), 100);

        // Auto remove after 4 seconds
        setTimeout(() => {
            toast.style.animation = 'slideOutRight 0.4s ease-in-out forwards';
            setTimeout(() => toast.remove(), 400);
        }, 4000);
    }

    document.getElementById('addNewItemBtn').addEventListener('click', function() {
        console.log('[v0] New Item button clicked!');
        console.log('[v0] Form container element:', document.getElementById('newItemFormContainer'));
        console.log('[v0] Modal overlay element:', document.getElementById('modalOverlay'));

        const formContainer = document.getElementById('newItemFormContainer');
        const modalOverlay = document.getElementById('modalOverlay');

        if (formContainer && modalOverlay) {
            formContainer.style.display = 'block';
            modalOverlay.style.display = 'block';
            console.log('[v0] Form and overlay should now be visible');
        } else {
            console.error('[v0] Could not find form container or modal overlay elements');
        }
    });

    document.getElementById('cancelNewItem').addEventListener('click', function() {
        console.log('[v0] Cancel new item clicked');
        document.getElementById('newItemFormContainer').style.display = 'none';
        document.getElementById('modalOverlay').style.display = 'none';
        document.getElementById('newItemForm').reset();
    });

    document.getElementById('newItemForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const itemData = {
            name: formData.get('name'),
            description: formData.get('description'),
            price: parseFloat(formData.get('price')),
            category: formData.get('category'),
            available: formData.get('available') === 'true',
            type: formData.get('type')
        };

        fetch(contextPath + '/menu-items', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(itemData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('success', 'Item Added!', `"${itemData.name}" has been added to the menu.`);
                    document.getElementById('newItemFormContainer').style.display = 'none';
                    document.getElementById('modalOverlay').style.display = 'none';
                    document.getElementById('newItemForm').reset();

                    // Refresh the menu
                    const activeCategoryBtn = document.querySelector('.category-btn.active');
                    let activeCategory = activeCategoryBtn ? (activeCategoryBtn.getAttribute('data-category') || activeCategoryBtn.textContent.trim()) : null;
                    if (activeCategory === 'All') activeCategory = null;
                    const available = getAvailabilityState();
                    const searchTerm = document.getElementById('searchInput').value.trim();
                    loadMenu(activeCategory, available, searchTerm);
                } else {
                    if (data.message && data.message.includes('already exists')) {
                        showToast('error', 'Duplicate Name Error', data.message);
                    } else {
                        showToast('error', 'Failed to Add Item', data.message || 'An unexpected error occurred.');
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('error', 'Connection Error', 'Unable to connect to server. Please try again.');
            });
    });

    document.getElementById('cancelEditItem').addEventListener('click', hideEditForm);

    document.getElementById('editItemForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const itemData = {
            id: parseInt(formData.get('id')),
            name: formData.get('name'),
            description: formData.get('description'),
            price: parseFloat(formData.get('price')),
            category: formData.get('category'),
            available: formData.get('available') === 'true',
            type: formData.get('type')
        };

        fetch(contextPath + '/menu-items', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(itemData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('success', 'Item Updated!', `"${itemData.name}" has been updated.`);
                    hideEditForm();

                    // Refresh the menu
                    const activeCategoryBtn = document.querySelector('.category-btn.active');
                    let activeCategory = activeCategoryBtn ? (activeCategoryBtn.getAttribute('data-category') || activeCategoryBtn.textContent.trim()) : null;
                    if (activeCategory === 'All') activeCategory = null;
                    const available = getAvailabilityState();
                    const searchTerm = document.getElementById('searchInput').value.trim();
                    loadMenu(activeCategory, available, searchTerm);
                } else {
                    showToast('error', 'Failed to Update Item', data.message || 'An unexpected error occurred.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('error', 'Connection Error', 'Unable to connect to server. Please try again.');
            });
    });

    document.getElementById('deleteItemBtn').addEventListener('click', function() {
        const itemName = document.getElementById('editItemName').value;
        hideEditForm();
        showDeleteConfirmation(itemName);
    });

    document.getElementById('setSpecialBtn').addEventListener('click', function() {
        const itemId = document.getElementById('editItemId').value;
        const itemName = document.getElementById('editItemName').value;
        setTodaysSpecial(itemId, itemName);
        hideEditForm();
    });

    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        const itemId = document.getElementById('editItemId').value;

        fetch(contextPath + '/menu-items?id=' + itemId, {
            method: 'DELETE'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('success', 'Item Deleted!', 'The item has been removed from the menu.');
                    hideDeleteConfirmation();

                    // Refresh the menu
                    const activeCategoryBtn = document.querySelector('.category-btn.active');
                    let activeCategory = activeCategoryBtn ? (activeCategoryBtn.getAttribute('data-category') || activeCategoryBtn.textContent.trim()) : null;
                    if (activeCategory === 'All') activeCategory = null;
                    const available = getAvailabilityState();
                    const searchTerm = document.getElementById('searchInput').value.trim();
                    loadMenu(activeCategory, available, searchTerm);
                } else {
                    showToast('error', 'Failed to Delete Item', data.message || 'An unexpected error occurred.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('error', 'Connection Error', 'Unable to connect to server. Please try again.');
            });
    });

    document.getElementById('cancelDeleteBtn').addEventListener('click', hideDeleteConfirmation);

    document.getElementById('modalOverlay').addEventListener('click', function() {
        document.getElementById('newItemFormContainer').style.display = 'none';
        document.getElementById('editItemFormContainer').style.display = 'none';
        document.getElementById('deleteConfirmDialog').style.display = 'none';
        this.style.display = 'none';
    });

    function initializeToggleState() {
        const toggle = document.querySelector('.toggle-switch');
        toggle.classList.add('active'); // Initially show only available items
        toggle.style.backgroundColor = '#4CAF50'; // Green for available
    }

    console.log('[v0] Page loaded, initializing...');
    console.log('[v0] Add new item button element:', document.getElementById('addNewItemBtn'));

    initializeToggleState();
    loadTodaysSpecial();
    const defaultCategoryBtn = document.querySelector('.category-btn.active');
    let defaultCategory = defaultCategoryBtn ? (defaultCategoryBtn.getAttribute('data-category') || defaultCategoryBtn.textContent.trim()) : 'All';
    if (defaultCategory === 'All') defaultCategory = null;
    const initialAvailable = getAvailabilityState(); // This will now return true (available only)
    console.log('[v0] Initial load with category:', defaultCategory, 'available:', initialAvailable); // Debug log
    loadMenu(defaultCategory, initialAvailable);
</script>
</body>
</html>
